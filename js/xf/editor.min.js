/*
 * XenForo editor.min.js
 * Copyright 2010-2018 XenForo Ltd.
 * Released under the XenForo License Agreement: https://xenforo.com/license-agreement
 */
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(d,l,m){d instanceof String&&(d=String(d));for(var p=d.length,a=0;a<p;a++){var c=d[a];if(l.call(m,c,a,d))return{i:a,v:c}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(d,l,m){d!=Array.prototype&&d!=Object.prototype&&(d[l]=m.value)};
$jscomp.getGlobal=function(d){return"undefined"!=typeof window&&window===d?d:"undefined"!=typeof global&&null!=global?global:d};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(d,l,m,p){if(l){m=$jscomp.global;d=d.split(".");for(p=0;p<d.length-1;p++){var a=d[p];a in m||(m[a]={});m=m[a]}d=d[d.length-1];p=m[d];l=l(p);l!=p&&null!=l&&$jscomp.defineProperty(m,d,{configurable:!0,writable:!0,value:l})}};
$jscomp.polyfill("Array.prototype.find",function(d){return d?d:function(d,m){return $jscomp.findInternal(this,d,m).v}},"es6","es3");
!function(d,l,m,p){XF.isEditorEnabled=function(){return XF.LocalStorage.get("editorDisabled")?!1:!0};XF.setIsEditorEnabled=function(a){a?XF.LocalStorage.remove("editorDisabled"):XF.LocalStorage.set("editorDisabled","1",!0)};XF.Editor=XF.Element.newHandler({options:{maxHeight:.7,minHeight:250,buttonsRemove:"",attachmentTarget:!0,attachmentUploader:".js-attachmentUpload",attachmentContextInput:"attachment_hash_combined"},$form:null,ed:null,mentioner:null,uploadUrl:null,init:function(){if(this.$target.is("textarea")){this.$target.trigger("editor:start",
[this]);this.$form=this.$target.closest("form");this.$form.length||(this.$form=null);this.options.attachmentTarget&&(this.uploadUrl=this.$target.closest("[data-xf-init~=attachment-manager]").find(this.options.attachmentUploader).attr("href"));var a=this;this.$target.css("visibility","").on("froalaEditor.initialized",function(c,b){a.ed=b;a.editorInit()}).froalaEditor(this.getEditorConfig())}else console.error("Editor can only be initialized on a textarea")},getEditorConfig:function(){var a=this.getHeightLimits();
a={direction:d.FE.LANGUAGE.xf.direction,editorClass:"bbWrapper",fileAllowedTypes:[],fileMaxSize:4294967296,fileUploadParam:"upload",fileUploadURL:!1,fontFamily:{arial:"Arial","'book antiqua'":"Book Antiqua","'courier new'":"Courier New",georgia:"Georgia",tahoma:"Tahoma","'times new roman'":"Times New Roman","'trebuchet ms'":"Trebuchet MS",verdana:"Verdana"},fontSize:"9 10 12 15 18 22 26".split(" "),heightMin:a[0],heightMax:a[1],htmlAllowedTags:"a b bdi bdo blockquote br cite code dfn div em h1 h2 h3 h4 h5 h6 hr i img li mark ol p pre s script style small span strike strong sub sup table tbody td tfoot th thead time tr u ul var wbr".split(" "),
key:"AODOd2HLEBFZOTGHW==",htmlAllowComments:!1,imageAllowedTypes:[],imageCORSProxy:null,imageDefaultDisplay:"inline",imageDefaultWidth:"auto",imageEditButtons:"imageReplace imageRemove | imageLink linkOpen linkEdit linkRemove".split(" "),imageManagerLoadURL:!1,imageMaxSize:4294967296,imagePaste:!1,imageResize:!1,imageUploadParam:"upload",imageUploadRemoteUrls:!1,imageUploadURL:!1,language:"xf",linkAlwaysBlank:!0,linkEditButtons:["linkOpen","linkEdit","linkRemove"],linkInsertButtons:["linkBack"],placeholderText:"",
toolbarSticky:!1,videoUploadURL:!1,xfBbCodeAttachmentContextInput:this.options.attachmentContextInput};d.FE.DT=!0;if(this.uploadUrl){var c={_xfToken:XF.config.csrf,_xfResponseType:"json",_xfWithData:1};a.fileAllowedTypes=["*"];a.fileUploadParams=c;a.fileUploadURL=this.uploadUrl;a.imageAllowedTypes=["jpeg","jpg","png","gif"];a.imageUploadParams=c;a.imageUploadURL=this.uploadUrl;a.imagePaste=!0}else a.imageInsertButtons=["imageByURL"];c=this.getButtonConfig();a=d.extend({},a,c);this.$target.trigger("editor:config",
[a,this]);return a},getButtonConfig:function(){var a="clearFormatting,|,bold,italic,underline,strikeThrough,|,color,fontFamily,fontSize,|,insertLink,insertImage,xfSmilie,xfInsert,|,xfCustomPlaceholder,|,align,xfList,|,undo,redo,|,xfDraft,xfBbCode",c={_basic:["bold","italic","underline","strikeThrough"],_extended:["color","fontFamily","fontSize"],_link:["insertLink"],_align:["align"],_list:["formatOL","formatUL","outdent","indent"],_indent:["outdent","indent"],_smilies:["xfSmilie"],_image:["insertImage"],
_media:["xfMedia"],_block:["xfQuote","xfCode","xfSpoiler"]},b="xfMedia,xfQuote,xfSpoiler,xfCode,xfInlineCode",e="formatOL,formatUL,outdent,indent",f,d=XF.editorStart.custom.length?XF.editorStart.custom.join(","):"";a=a.replace("xfCustomPlaceholder",d);b=b.replace("xfCustomPlaceholder",d);d=function(a){return a.replace(/\|,\|(,\|)*/g,"|").replace(/^\|,/,"").replace(/,\|$/,"").replace(/^,+/,"").replace(/,+$/,"")};var g=function(a,b){"string"==typeof b&&c[b]&&(b=c[b]);"string"!=typeof b&&(b=b.join("|"));
return a.replace(new RegExp("(^|,)("+b+")(?=,|$)","g"),"$1")},k=function(a){return a.length?a.split(","):[]};this.$form&&this.$form.is("[data-xf-init~=draft]")||(a=g(a,"xfDraft"));if(this.options.buttonsRemove){var n=this.options.buttonsRemove.split(",");for(f=0;f<n.length;f++)a=g(a,n[f]),b=g(b,n[f]),e=g(e,n[f])}b=d(b);e=d(e);n={buttons:a,xsRemove:["fontFamily","outdent","indent","strikeThrough","xfDraft"],insertButtons:b,listButtons:e,helpers:{removeButton:g,cleanUp:d,splitButtons:k}};this.$target.trigger("editor:buttons",
[n,this]);a=n.buttons;b.length||(a=g(a,"xfInsert"));e.length||(a=g(a,"xfList"));b=a;e=n.xsRemove;for(f=0;f<e.length;f++)b=g(b,e[f]);a=k(d(a));f=k(d(b));return{toolbarButtons:a,toolbarButtonsMD:a,toolbarButtonsSM:a,toolbarButtonsXS:f,xfInsertOptions:k(d(n.insertButtons)),xfListOptions:k(d(n.listButtons))}},editorInit:function(){var a=this,c=this.ed;this.watchEditorHeight();this.$form&&(this.$form.on("ajax-submit:before draft:beforesync",function(){c.$oel.val(a.ed.html.get())}),this.$form.on("draft:complete",
function(){var a=c.$tb.find(".fr-command.fr-btn[data-cmd=xfDraft]"),b=a.find(".editorDraftIndicator");b.length||(b=d('<b class="editorDraftIndicator" />').appendTo(a));setTimeout(function(){b.addClass("is-active")},50);setTimeout(function(){b.removeClass("is-active")},2500)}),c.events.on("keydown",function(c){if(13==c.which&&(XF.isMac()?c.metaKey:c.ctrlKey))return c.preventDefault(),a.$form.submit(),!1},!0));c.$tb.find("[data-cmd=align][data-param1=justify]").closest("li").css("display","none");c.events.on("image.inserted",
function(a){a.removeClass("fr-dib").addClass("fr-dii")});c.events.on("image.beforePasteUpload",function(a){if("data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="==a.src)return!1});var b=!1;c.events.on("cut copy",function(a){if((a=c.selection.ranges(0))&&a.commonAncestorContainer){a=a.commonAncestorContainer;a.nodeType==Node.TEXT_NODE&&(a=a.parentNode);var b=d(a).find("p");d(a).find("p").attr("data-xf-p","1");setTimeout(function(){b.removeAttr("data-xf-p")},0)}});c.events.on("paste.before",
function(a){b=!1;if(a&&a.clipboardData&&a.clipboardData.getData){var e="";a=a.clipboardData.types;if(c.helpers.isArray(a))for(var d=0;d<a.length;d++)e+=a[d]+";";else e=a;!/text\/plain/.test(e)||c.browser.mozilla||/text\/html/.test(e)||/text\/rtf/.test(e)&&c.browser.safari||(b=!0)}});c.events.on("paste.beforeCleanup",function(a){b&&(a=a.replace(/\t/g,"    ").replace(/  /g,"&nbsp; ").replace(/  /g,"&nbsp; ").replace(/> /g,">&nbsp;"));a=a.replace(/(<pre[^>]*>)([\s\S]+)(<\/pre>)/g,function(a,c,b,e){b=
b.replace(/\r?\n/g,"<br>");return c+b+e});a=a.replace(/<div(?=\s|>)/g,function(a){return a+' data-xf-p="1"'});return XF.adjustHtmlForRte(a)});c.events.on("paste.afterCleanup",function(c){return a.normalizePaste(c)});c.events.on("paste.after",function(){var b=c.selection.ranges(0);if(b&&b.getBoundingClientRect){b=b.getBoundingClientRect();var e=c.$wp[0].getBoundingClientRect();(0>b.top||0>b.left||b.bottom>d(l).height()||b.right>d(l).width()||b.bottom>e.bottom)&&setTimeout(function(){a.scrollToCursor()},
100)}});c.events.on("popups.show.colors.picker",function(){d(this.popups.get("colors.picker")).find(".fr-colors-buttons").css("display","none")});this.mentioner=new XF.EditorMentioner(c);this.setupUploads();if(!XF.isEditorEnabled()){var e=this.$target.next("input[data-bb-code]");e.length?c.bbCode.toBbCode(e.val(),!0):c.bbCode.toBbCode(null,!0)}XF.EditorHelpers.setupBlurSelectionWatcher(c);this.$target.trigger("editor:init",[c,this]);XF.layoutChange()},focus:function(){XF.EditorHelpers.focus(this.ed)},
blur:function(){this.ed.$el[0].blur();this.ed.selection.clear()},normalizePaste:function(a){a=a.replace(/(<(ul|li|p|div)>)\s+/ig,"$1");a=a.replace(/\s+(<\/(ul|li|p|div)>)/ig,"$1");a=a.replace(/<span>&nbsp;<\/span>/ig," ").replace(/(<\/li>)\s+(<li)/ig,"$1$2");var c=this.ed,b=d.parseHTML(a),e=d("<div />").html(b);e.find("tr").replaceWith(function(){return this.innerHTML+"<br>"});e.find("td, tbody, thead, tfoot, table").replaceWith(function(){return this.innerHTML+" "});e.find("th").replaceWith(function(){return"<b>"+
this.innerHTML+"</b> "});e.find("code, del, ins, sub, sup").replaceWith(function(){return this.innerHTML});e.find("h1, h2, h3, h4, h5, h6").replaceWith(function(){var a="<b>"+this.innerHTML+"</b>",b=c.opts.fontSize;switch(this.tagName){case "H1":a='<span style="font-size: '+b[6]+'px">'+a+"</span>";break;case "H2":a='<span style="font-size: '+b[5]+'px">'+a+"</span>";break;case "H3":a='<span style="font-size: '+b[4]+'px">'+a+"</span>"}return a+"<br>"});e.find("pre").replaceWith(function(){var a=this.innerHTML;
a=a.replace(/\r?\n/g,"<br>").replace(/\t/g,"    ").replace(/  /g,"&nbsp; ").replace(/  /g,"&nbsp; ").replace(/> /g,">&nbsp;").replace(/<br> /g,"<br>&nbsp;");return a+"<br>"});e.find("br").each(function(a,b){var f=d(b).parents().not(e);if(f.length&&!f.filter(function(a,b){return c.node.isBlock(b)}).length){a=d([]);var k=!1,g=b,h=f.last();do{for(;g.nextSibling;)f=d(g.nextSibling).clone(),k?a.append(f):a=a.add(f),d(g.nextSibling).remove();g=g.parentNode;if(!g||e.is(g))break;f=d(g).clone().empty();f.html(a);
a=f;k=!0}while(g.parentNode&&!e.is(g.parentNode));d(b).remove();h.after(a);h.after("<br />")}});a="";b=e[0].textContent.replace(/\s/g,"");try{a=(c.win.localStorage.getItem("fr-copied-text")||"").replace(/\s/g,"")}catch(k){}a.length&&a!=b&&e.find("> p:not([data-xf-p])").each(function(){this.nextSibling&&d(this).after("<p />")});e.find("p").removeAttr("data-xf-p");b=e.contents();a=d("<div />");for(var f=null,h=0;h<b.length;h++){var g=b[h];g.nodeType==Node.ELEMENT_NODE&&c.node.isBlock(g)?(a.append(g),
f=null):g.nodeType==Node.ELEMENT_NODE&&"BR"==g.tagName?(f||a.append("<p />"),f=null):(f||(f=d("<p />"),a.append(f)),f.append(g))}b=a.children();1==b.length&&b.is("p, div")&&(a=b);return a.html()},watchEditorHeight:function(){var a=this.ed,c=this;d(l).onPassive("resize",function(){var b=c.getHeightLimits();a.opts.heightMin=b[0];a.opts.heightMax=b[1];a.size.refresh();XF.layoutChange()});a.events.on("focus",function(){c.scrollToCursorAfterPendingResize()});var b=a.$wp.height(),e=function(){var c=a.$wp.height();
b!=c&&(b=c,XF.layoutChange())};a.events.on("keyup",e);a.events.on("commands.after",e);a.events.on("html.set",e);a.events.on("init",e);a.events.on("initialized",e)},getHeightLimits:function(){var a=this.options.maxHeight,c=this.options.minHeight,b=null,e=null;this.$target.closest(".overlay").length&&(a=.1);a&&(b=d(l).height(),/(iPad|iPhone|iPod)/g.test(navigator.userAgent)&&(b-=250),b=Math.floor(0<a?1>=a?b*a:a:b+a),b=Math.max(b,150));c&&b&&(e=Math.min(c,b),e==b&&--e);return[e,b]},setupUploads:function(){var a=
this,c=this.ed;c.events.on("file.uploaded",function(b){this.popups.hide("file.insert");this.events.focus();return a.handleUploadSuccess(b)});c.events.on("file.error",function(b,c){this.popups.hide("file.insert");a.handleUploadError(b,c);this.events.focus();return!1});this.uploadUrl||(c.events.on("image.beforeUpload",function(){return!1}),c.events.on("file.beforeUpload",function(){return!1}));c.events.on("image.error",function(b,c){if(c)return this.popups.hide("image.insert"),a.handleUploadError(b,
c),!1});c.events.on("image.uploaded",function(b){return a.handleUploadSuccess(b,function(){c.image.remove();c.popups.hide("image.insert");c.events.focus();return!1},function(){return!0})});var b=function(a,b){if(b){try{var c=d.parseJSON(b)}catch(n){return}if(c.attachment){b=c.attachment.attachment_id;c=a[0].attributes;for(var e=/^data-/,f=c.length-1;0<=f;f--)e.test(c[f].nodeName)&&a.removeAttr(c[f].nodeName);a.attr("data-attachment","full:"+b).attr("alt",b)}}};c.events.on("image.inserted",b);c.events.on("image.replaced",
b);c.events.on("image.loaded",function(b){if(c.popups.isVisible("image.edit")){var e=c.image.get();e&&e[0]==b[0]&&(c.image.exitEdit(!0),e=c.selection.ranges(0),e.setStartAfter(b[0]),e.collapse(!0),b=c.selection.get(),b.removeAllRanges(),b.addRange(e),c.events.focus(),a.scrollToCursor())}})},handleUploadSuccess:function(a,c,b){try{var e=d.parseJSON(a)}catch(f){e={status:"error",errors:[XF.phrase("oops_we_ran_into_some_problems")]}}return e.status&&"error"==e.status?(XF.alert(e.errors[0]),c?c(e):!1):
(a=this.getAttachmentManager())&&e.attachment?(a.insertUploadedRow(e.attachment),b?b(e,a):!1):!1},handleUploadError:function(a,c){try{var b=d.parseJSON(c)}catch(e){b=null}b&&b.errors||(b={status:"error",errors:[XF.phrase("oops_we_ran_into_some_problems")]});XF.alert(b.errors[0])},getAttachmentManager:function(){var a=this.$target.closest("[data-xf-init~=attachment-manager]");return a&&a.length?XF.Element.getHandler(a,"attachment-manager"):null},isBbCodeView:function(){return this.ed.bbCode&&this.ed.bbCode.isBbCodeView?
this.ed.bbCode.isBbCodeView():!1},insertContent:function(a,c){var b=this.ed;this.isBbCodeView()?"undefined"!==typeof c&&b.bbCode.insertBbCode(c):(this.focus(),b.html.insert(a));this.scrollToCursor();this.scrollToCursorAfterPendingResize()},replaceContent:function(a,c){var b=this.ed;this.isBbCodeView()?"undefined"!==typeof c&&b.bbCode.replaceBbCode(c):b.html.set(a)},scrollToCursor:function(){var a=this.ed;if(this.isBbCodeView())a.bbCode.getTextArea().autofocus(),a.$box[0].scrollIntoView(!0);else{this.focus();
var c=a.$box,b=a.$wp,e=a.selection.endElement(),d=e.getBoundingClientRect().bottom,h=!0;a=XF.windowHeight();XF.browser.ios&&(a-=250);if(0>d||d>=a)h=!1;if(b&&h){var g=b[0].getBoundingClientRect();if(d>g.bottom||d<g.top)h=!1}if(!h){d=c[0].getBoundingClientRect();if(0>d.top||d.bottom>=a)XF.browser.ios||c.addClass("is-scrolling-to"),c[0].scrollIntoView(!0),c.removeClass("is-scrolling-to");b?(d=e.getBoundingClientRect().bottom,c=b[0].scrollTop+d-b[0].getBoundingClientRect().top,b.scrollTop(c+a/2)):e.scrollIntoView()}}},
scrollToCursorAfterPendingResize:function(a){var c=this,b=this.ed,e,f=function(){d(l).off("resize",f);d(l).on("scroll",h);e&&clearTimeout(e);e=setTimeout(g,500)},h=function(){e&&clearTimeout(e);e=setTimeout(g,100)},g=function(){d(l).off("scroll",h);b.core.hasFocus()&&c.scrollToCursor()};d(l).on("resize",f);setTimeout(function(){d(l).off("resize",f)},2E3);a&&(e=setTimeout(g,1E3))}});XF.EditorMentioner=XF.create({ed:null,visible:!1,idleWait:200,idleTimer:null,pendingMention:"",results:null,__construct:function(a){var c=
this;this.ed=a;this.results=new XF.AutoCompleteResults({onInsert:function(a){c.insertMention(a)},clickAttacher:function(a,d){c.ed.events.bindClick(a,a,d)}});a.events.on("keydown",XF.proxy(this,"keydown"),!0);a.events.on("keyup",XF.proxy(this,"keyup"),!0);a.events.on("click blur",function(){c.hide()});a.$wp.onPassive("scroll",function(){c.hide()})},keydown:function(a){if(this.visible){var c=this.results,b=function(){a.preventDefault();return!1};switch(a.which){case 40:return c.selectResult(1),b();
case 38:return c.selectResult(-1),b();case 27:return this.hide(),b();case 13:return c.insertSelectedResult(),b()}}},keyup:function(a){if(this.visible)switch(a.which){case 40:case 38:case 13:return}this.hide();this.idleTimer&&clearTimeout(this.idleTimer);this.idleTimer=setTimeout(XF.proxy(this,"lookForMention"),this.idleWait)},lookForMention:function(){var a=this.getCurrentMentionInfo();a?this.foundMention(a.name):this.hide()},getCurrentMentionInfo:function(){var a=this.ed.selection.ranges(0);if(!a||
!a.collapsed)return null;var c=a.endContainer;if(!c||3!=c.nodeType)return null;var b=c.nodeValue.substring(0,a.endOffset),d=b.lastIndexOf("@");if(-1==d)return null;if(0==d||b.substr(d-1,1).match(/(\s|[\](,]|--)/))if(b=b.substr(d+1),!b.match(/\s/)||10>=b.length)return{textNode:c,start:d,name:b.replace(new RegExp(String.fromCharCode(160),"g")," "),range:a};return null},foundMention:function(a){this.pendingMention!=a&&(this.pendingMention=a,2<=a.length&&"["!=a.substr(0,1)&&this.getPendingMentionOptions())},
getPendingMentionOptions:function(){XF.ajax("GET",XF.getAutoCompleteUrl(),{q:this.pendingMention},XF.proxy(this,"handlePendingMentionOptions"),{global:!1,error:!1})},handlePendingMentionOptions:function(a){var c=this.getCurrentMentionInfo();a.q&&c&&a.q==c.name&&(a.results?this.show(a.q,a.results):this.hide())},insertMention:function(a){this.hide();XF.EditorHelpers.focus(this.ed);var c=this.getCurrentMentionInfo();if(c){var b=c.textNode,d=b.nodeValue,f=c.start+1,h=c.range;b.nodeValue=d.substr(0,f)+
a+"\u00a0"+d.substr(f+c.name.length);h.setEnd(b,f+a.length+1);h.collapse(!1);a=this.ed.selection.get();a.removeAllRanges();a.addRange(h)}},show:function(a,c){var b=this.getCurrentMentionInfo(),e=b.range,f=this.ed.$el;b&&(this.visible=!0,this.results.showResults(a,c,f,function(a){var c=f.dimensions();if(!e||!e.getBoundingClientRect){var k=e.startContainer;return{top:(3==k.nodeType?d(k.parentNode):d(k)).dimensions().bottom+3,left:c.left+5}}k=e.cloneRange();k.setStart(b.textNode,b.start);k.setEnd(b.textNode,
b.start+1);k=k.getBoundingClientRect();a=a.width();var h=k.bottom+d(l).scrollTop()+3;k=k.left;k+a>c.right&&(k=e.getBoundingClientRect().left-a);k<c.left&&(k=c.left);return{top:h,left:k}}))},hide:function(){this.visible&&(this.visible=!1,this.results.hideResults())}});XF.EditorHelpers={setupBlurSelectionWatcher:function(a){var c=a.$el,b=!1,e;d(m).on("mousedown keydown",function(c){b&&(a.$el[0]==c.target||d.contains(a.$el[0],c.target)||a.selection.inEditor()&&(e=a.selection.ranges(0)))});a.events.on("blur",
function(){e?c.data("xf-ed-blur-sel",e):c.removeData("xf-ed-blur-sel");b=!1;e=null},!0);a.events.on("focus",function(){b=!0;e=null;setTimeout(function(){c.removeData("xf-ed-blur-sel")},0)});a.events.on("commands.before",function(b){(b=d.FE.COMMANDS[b])&&("undefined"==typeof b.focus||b.focus)&&XF.EditorHelpers.restoreMaintainedSelection(a)})},restoreMaintainedSelection:function(a){var c=a.$el.data("xf-ed-blur-sel");a.selection.inEditor()||(c?(a.markers.remove(),a.markers.place(c,!0,0),a.markers.place(c,
!1,0)):a.selection.setAtEnd(a.el),a.selection.restore())},focus:function(a){XF.EditorHelpers.restoreMaintainedSelection(a);a.events.focus()},wrapSelectionText:function(a,c,b,d){d&&a.selection.save();d=a.$el.find(".fr-marker");d.first().before(XF.htmlspecialchars(c));d.last().after(XF.htmlspecialchars(b));a.selection.restore();a.placeholder.hide()},insertCode:function(a,c,b){switch(c.toLowerCase()){case "":var d="CODE";c="";break;default:d="CODE",c=c.toLowerCase()}b=b.replace(/&/g,"&amp;").replace(/</g,
"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/\t/g,"    ").replace(/\n /g,"\n&nbsp;").replace(/  /g,"&nbsp; ").replace(/  /g," &nbsp;").replace(/\n/g,"</p><p>");b="["+d+(c?"="+c:"")+"]"+b+"[/"+d+"]";b.match(/<\/p>/i)&&(b=("<p>"+b+"</p>").replace(/<p><\/p>/g,"<p><br></p>"));a.html.insert(b)},insertSpoiler:function(a,c){XF.EditorHelpers.wrapSelectionText(a,c?'[SPOILER="'+c+'"]':"[SPOILER]","[/SPOILER]",!0)},dialogs:{},loadDialog:function(a,c){var b=XF.EditorHelpers.dialogs;b[c]?b[c].show(a):
console.error("Unknown dialog '"+c+"'")},toggleSmilieBox:function(a,c){var b=a.$oel.data("xfSmilieBox");b&&(a.$wp.toggleClassTransitioned("smilieBox-active",c),b.toggleClassTransitioned("is-active",c),a.$tb.find(".fr-command[data-cmd=xfSmilie]").toggleClass("fr-active xxx",c))}};XF.EditorDialog=XF.create({ed:null,overlay:null,dialog:null,cache:!0,__construct:function(a){this.dialog=a},show:function(a){this.ed=a;a.selection.save();XF.loadOverlay(XF.canonicalizeUrl("index.php?editor/dialog&dialog="+
this.dialog),{beforeShow:XF.proxy(this,"beforeShow"),afterShow:XF.proxy(this,"afterShow"),init:XF.proxy(this,"init"),cache:this.cache})},init:function(a){var c=this;a.on("overlay:hidden",function(){c.ed&&c.ed.markers.remove()});this._init(a)},_init:function(a){},beforeShow:function(a){this.overlay=a;this._beforeShow(a)},_beforeShow:function(a){},afterShow:function(a){this._afterShow(a);a.$overlay.find("textarea, input").first().focus()},_afterShow:function(a){}});XF.EditorDialogMedia=XF.extend(XF.EditorDialog,
{_beforeShow:function(a){d("#editor_media_url").val("")},_init:function(a){d("#editor_media_form").submit(XF.proxy(this,"submit"))},submit:function(a){a.preventDefault();var c=this.ed,b=this.overlay;XF.ajax("POST",XF.canonicalizeUrl("index.php?editor/media"),{url:d("#editor_media_url").val()},function(a){a.matchBbCode?(c.selection.restore(),c.html.insert(XF.htmlspecialchars(a.matchBbCode)),b.hide()):a.noMatch?XF.alert(a.noMatch):(c.selection.restore(),b.hide())})}});XF.EditorDialogSpoiler=XF.extend(XF.EditorDialog,
{_beforeShow:function(a){d("#editor_spoiler_title").val("")},_init:function(a){d("#editor_spoiler_form").submit(XF.proxy(this,"submit"))},submit:function(a){a.preventDefault();a=this.ed;var c=this.overlay;a.selection.restore();XF.EditorHelpers.insertSpoiler(a,d("#editor_spoiler_title").val());c.hide()}});XF.EditorDialogCode=XF.extend(XF.EditorDialog,{_beforeShow:function(a){this.ed.$el.blur()},_init:function(a){d("#editor_code_form").submit(XF.proxy(this,"submit"))},submit:function(a){a.preventDefault();
a=this.ed;var c=this.overlay,b=c.$container.find(".CodeMirror");if(b.length){b=b[0].CodeMirror;var e=b.getDoc();b.save();e.setValue("");b.setOption("mode","")}b=d("#editor_code_type");e=d("#editor_code_code");a.selection.restore();XF.EditorHelpers.insertCode(a,b.val(),e.val());c.hide();e.val("");b.val("")}});XF.editorStart={started:!1,custom:[],startAll:function(){XF.editorStart.started||(XF.editorStart.setupLanguage(),XF.editorStart.registerCommands(),XF.editorStart.registerCustomCommands(),XF.editorStart.registerDialogs(),
d(m).trigger("editor:first-start"),XF.editorStart.started=!0)},setupLanguage:function(){var a=d("html").attr("dir");try{var c=d.parseJSON(d(".js-editorLanguage").first().html())||{}}catch(b){console.error(b),c={}}d.FE.LANGUAGE.xf={translation:c,direction:a?a.toLowerCase():"ltr"}},registerCommands:function(){d.FE.DefineIcon("xfQuote",{NAME:"quote-right"});d.FE.RegisterCommand("xfQuote",{title:"Quote",icon:"xfQuote",undo:!0,focus:!0,callback:function(){XF.EditorHelpers.wrapSelectionText(this,"[QUOTE]",
"[/QUOTE]",!0)}});d.FE.DefineIcon("xfCode",{NAME:"code"});d.FE.RegisterCommand("xfCode",{title:"Code",icon:"xfCode",undo:!0,focus:!0,callback:function(){XF.EditorHelpers.loadDialog(this,"code")}});d.FE.DefineIcon("xfInlineCode",{NAME:"terminal"});d.FE.RegisterCommand("xfInlineCode",{title:"Inline Code",icon:"xfInlineCode",undo:!0,focus:!0,callback:function(){XF.EditorHelpers.wrapSelectionText(this,"[ICODE]","[/ICODE]",!0)}});d.FE.DefineIcon("xfMedia",{NAME:"video-camera"});d.FE.RegisterCommand("xfMedia",
{title:"Media",icon:"xfMedia",undo:!0,focus:!0,callback:function(){XF.EditorHelpers.loadDialog(this,"media")}});d.FE.DefineIcon("xfSpoiler",{NAME:"flag"});d.FE.RegisterCommand("xfSpoiler",{title:"Spoiler",icon:"xfSpoiler",undo:!0,focus:!0,callback:function(){XF.EditorHelpers.loadDialog(this,"spoiler")}});d.FE.DefineIcon("xfSmilie",{NAME:"smile-o"});d.FE.RegisterCommand("xfSmilie",{title:"Smilies",icon:"xfSmilie",undo:!1,focus:!1,refresh:function(a){var c=this.$oel.data("xfSmilieBox"),b=!1;c&&(b=c.hasClass("is-active"));
a.toggleClass("fr-active",b)},callback:function(){var a=this,c=a.$oel.data("xfSmilieBox");if(c){var b=c.hasClass("is-active");XF.EditorHelpers.toggleSmilieBox(a,b?!1:!0)}else c=d('<div class="editorSmilies" />'),a.$oel.data("xfSmilieBox",c),a.$wp.before(c),XF.ajax("GET",XF.canonicalizeUrl("index.php?editor/smilies"),{},function(b){b.html&&XF.setupHtmlInsert(b.html,function(b){a.events.bindClick(c,"img.smilie",function(b){b=d(b.currentTarget).clone();b.addClass("fr-draggable");XF.EditorHelpers.focus(a);
a.html.insert(d("<div />").html(b).html())});c.html(b);XF.EditorHelpers.toggleSmilieBox(a,!0)})})}});d.FE.DefineIcon("xfDraft",{NAME:"floppy-o"});d.FE.RegisterCommand("xfDraft",{type:"dropdown",title:"Drafts",focus:!0,undo:!1,options:{xfDraftSave:"Save Draft",xfDraftDelete:"Delete Draft"},callback:function(a,c){a=this.$el.closest("form");a.length?(a=XF.Element.getHandler(a,"draft"))?"xfDraftSave"==c?a.triggerSave():"xfDraftDelete"==c&&a.triggerDelete():console.error("No draft handler on parent form"):
console.error("No parent form to find draft handler")}});d.extend(d.FE.DEFAULTS,{xfBbCodeAttachmentContextInput:"attachment_hash_combined"});d.FE.PLUGINS.bbCode=function(a){function c(){return a.$tb.find(".fr-command[data-cmd=xfBbCode]")}function b(){var b=a.$oel,c=b.data("xfBbCodeBox");if(!c){var e=parseInt(a.$wp.css("border-bottom-width"),10)+parseInt(a.$wp.css("border-top-width"),10);c=d('<textarea class="input" style="display: none" />');c.css({minHeight:a.opts.heightMin?a.opts.heightMin+e+"px":
null,maxHeight:a.opts.heightMax?a.opts.heightMax+"px":null,height:a.opts.height?a.opts.height+e+"px":null,padding:a.$el.css("padding")});c.attr("name",b.data("original-name"));b.data("xfBbCodeBox",c);a.$wp.after(c);XF.Element.applyHandler(c,"textarea-handler");XF.Element.applyHandler(c,"user-mentioner")}return c}function e(d,e){var f=b(),g=function(b,d){h=!0;var e;(e=a.$oel.data("xfSmilieBox"))&&e.hasClass("is-active")&&XF.EditorHelpers.toggleSmilieBox(a,!1);a.undo.saveStep();a.$el.blur();e=c();a.$tb.find(" > .fr-command").not(e).addClass("fr-disabled");
e.addClass("fr-active");a.$wp.css("display","none");a.$oel.prop("disabled",!0);f.val(b).css("display","").prop("disabled",!1).trigger("autosize");d||f.autofocus();XF.setIsEditorEnabled(!1)};"string"==typeof d?g(d,e):XF.ajax("POST",XF.canonicalizeUrl("index.php?editor/to-bb-code"),{html:a.html.get()},function(a){g(a.bbCode,e)})}function f(e){var f=b(),g=function(b){h=!1;var d=c();a.$tb.find(" > .fr-command").not(d).removeClass("fr-disabled");d.removeClass("fr-active");a.$oel.prop("disabled",!1);a.html.set(b);
f.css("display","none").prop("disabled",!0);a.$wp.css("display","");a.events.focus();a.undo.saveStep();XF.setIsEditorEnabled(!0);XF.layoutChange()};if("string"==typeof e)g(e);else{e={bb_code:f.val()};var l=a.$el.closest("form");l.length&&l[0][a.opts.xfBbCodeAttachmentContextInput]&&(e.attachment_hash_combined=d(l[0][a.opts.xfBbCodeAttachmentContextInput]).val());XF.ajax("POST",XF.canonicalizeUrl("index.php?editor/to-html"),e,function(a){g(a.editorHtml)})}}var h=!1;return{_init:function(){a.events.on("buttons.refresh",
function(){return!h})},toBbCode:e,isBbCodeView:function(){return h},getTextArea:function(){return h?b():null},insertBbCode:function(a){if(h){var c=b();XF.insertIntoTextBox(c,a)}},replaceBbCode:function(a){if(h){var c=b();XF.replaceIntoTextBox(c,a)}},toHtml:f,toggle:function(){h?f():e()}}};d.FE.DefineIcon("xfBbCode",{NAME:"cog"});d.FE.RegisterCommand("xfBbCode",{title:"Toggle BB Code",icon:"xfBbCode",undo:!1,focus:!1,forcedRefresh:!0,callback:function(){this.bbCode.toggle()}});d.extend(d.FE.DEFAULTS,
{xfInsertOptions:[]});d.FE.DefineIcon("xfInsert",{NAME:"ellipsis-h"});d.FE.RegisterCommand("xfInsert",{type:"dropdown",title:"Insert",icon:"xfInsert",undo:!1,focus:!0,html:function(){var a='<ul class="fr-dropdown-list">',c=this.opts.xfInsertOptions,b;for(b in c){var e=c[b];var f=d.FE.COMMANDS[e];a+='<li><a class="fr-command" data-cmd="'+e+'">'+this.icon.create(f.icon||e)+"&nbsp;&nbsp;"+this.language.translate(f.title)+"</a></li>"}return a+"</ul>"}});d.extend(d.FE.DEFAULTS,{xfListOptions:[]});d.FE.DefineIcon("xfList",
{NAME:"list"});d.FE.RegisterCommand("xfList",{type:"dropdown",title:"List",icon:"xfList",undo:!1,focus:!0,html:function(){var a='<ul class="fr-dropdown-list">',c=this.opts.xfListOptions,b;for(b in c){var e=c[b];var f=d.FE.COMMANDS[e];a+='<li><a class="fr-command" data-cmd="'+e+'">'+this.icon.create(f.icon||e)+"&nbsp;&nbsp;"+this.language.translate(f.title)+"</a></li>"}return a+"</ul>"}})},registerCustomCommands:function(){try{var a=d.parseJSON(d(".js-editorCustom").first().html())||{}}catch(b){console.error(b),
a={}}for(var c in a)a.hasOwnProperty(c)&&function(a,c){var b="xfCustom_"+a,e=a.toUpperCase();a={};"fa"==c.type?a={NAME:c.value}:"image"==c.type&&(a={template:"image",SRC:'"'+XF.canonicalizeUrl(c.value)+'"',ALT:'"'+c.title+'"'});d.FE.DefineIcon(b,a);d.FE.RegisterCommand(b,{title:c.title,icon:b,undo:!0,focus:!0,callback:function(){XF.EditorHelpers.wrapSelectionText(this,"yes"==c.option?"["+e+"=]":"["+e+"]","[/"+e+"]",!0)}});XF.editorStart.custom.push(b)}(c,a[c])},registerDialogs:function(){XF.EditorHelpers.dialogs.media=
new XF.EditorDialogMedia("media");XF.EditorHelpers.dialogs.spoiler=new XF.EditorDialogSpoiler("spoiler");XF.EditorHelpers.dialogs.code=new XF.EditorDialogCode("code")}};d(m).one("editor:start",XF.editorStart.startAll);XF.Element.register("editor","XF.Editor")}(jQuery,window,document);
