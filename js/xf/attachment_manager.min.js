/*
 * XenForo attachment_manager.min.js
 * Copyright 2010-2018 XenForo Ltd.
 * Released under the XenForo License Agreement: https://xenforo.com/license-agreement
 */
var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(c,f,e){c instanceof String&&(c=String(c));for(var g=c.length,a=0;a<g;a++){var b=c[a];if(f.call(e,b,a,c))return{i:a,v:b}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,f,e){c!=Array.prototype&&c!=Object.prototype&&(c[f]=e.value)};
$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(c,f,e,g){if(f){e=$jscomp.global;c=c.split(".");for(g=0;g<c.length-1;g++){var a=c[g];a in e||(e[a]={});e=e[a]}c=c[c.length-1];g=e[c];f=f(g);f!=g&&null!=f&&$jscomp.defineProperty(e,c,{configurable:!0,writable:!0,value:f})}};
$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(c,e){return $jscomp.findInternal(this,c,e).v}},"es6","es3");
!function(c,f,e,g){XF.AttachmentManager=XF.Element.newHandler({options:{uploadButton:".js-attachmentUpload",manageUrl:null,filesContainer:".js-attachmentFiles",fileRow:".js-attachmentFile",insertAllRow:".js-attachmentInsertAllRow",insertRow:".js-attachmentInsertRow",allActionButton:".js-attachmentAllAction",actionButton:".js-attachmentAction",uploadTemplate:".js-attachmentUploadTemplate",templateProgress:".js-attachmentProgress",templateError:".js-attachmentError",templateThumb:".js-attachmentThumb",
templateView:".js-attachmentView",allowDrop:!1},$filesContainer:null,template:null,$form:null,manageUrl:null,flow:null,fileMap:{},isUploading:!1,editor:null,init:function(){var a=this,b=this.options,c=this.$target;if(f.Flow){var d=navigator.userAgent;if(d.match(/Android [1-4]/)&&(d=d.match(/Chrome\/([0-9]+)/),!d||33>parseInt(d[1],10))){console.warn("Old Android WebView detected. Must fallback to basic uploader.");return}d=c.find(b.uploadButton);if(this.options.manageUrl)this.manageUrl=this.options.manageUrl;
else{if(!d.length){console.error("No manage URL specified and no uploaders available.");return}var e=d.first();this.manageUrl=e.data("upload-href")||e.attr("href")}this.$filesContainer=c.find(b.filesContainer);this.$filesContainer.on("click",b.actionButton,XF.proxy(this,"actionButtonClick")).on("click",b.allActionButton,XF.proxy(this,"allActionButtonClick"));(this.template=c.find(b.uploadTemplate).html())||console.error("No attached file template found.");if(b=this.setupFlow()){if(this.flow=b,this.setupUploadButtons(d,
b),this.options.allowDrop&&b.assignDrop([c[0]]),setTimeout(function(){a.editor=XF.getEditorInContainer(a.$target,"[data-attachment-target=false]");a.editor||a.removeInsertButtons(a.$filesContainer);a.toggleInsertAllRow()},50),this.$form=this.$target.closest("form"),this.$form.length)this.$form.on("ajax-submit:before",function(b,c){a.isUploading&&!confirm(XF.phrase("files_being_uploaded_are_you_sure"))&&(c.preventSubmit=!0)})}else console.error("No flow uploader support")}else console.error("flow.js must be loaded")},
setupFlow:function(){var a=this.getFlowOptions(),b=new Flow(a),c=this;if(!b.support){if(!f.FustyFlow)return null;a.matchJSON=!0;b=new FustyFlow(a)}b.on("fileAdded",XF.proxy(this,"fileAdded"));b.on("filesSubmitted",function(){c.setUploading(!0);b.upload()});b.on("fileProgress",XF.proxy(this,"uploadProgress"));b.on("fileSuccess",XF.proxy(this,"uploadSuccess"));b.on("fileError",XF.proxy(this,"uploadError"));return b},getFlowOptions:function(){return{target:this.manageUrl,allowDuplicateUploads:!0,fileParameterName:"upload",
query:XF.proxy(this,"uploadQueryParams"),simultaneousUploads:1,testChunks:!1,progressCallbacksInterval:100,chunkSize:4294967296,readFileFn:function(a,b,c,d,e){var h="slice";a.file.slice?h="slice":a.file.mozSlice?h="mozSlice":a.file.webkitSlice&&(h="webkitSlice");d||(d="");e.readFinished(a.file[h](b,c,d))}}},setupUploadButtons:function(a,b){a.each(function(){var a=c(this),d=a.data("accept")||"",e=c("<span />").insertAfter(a).append(a);"."==d&&(d="");a.click(function(a){a.preventDefault()});b.assignBrowse(e[0],
!1,!1,{accept:d});a=e.find("input[type=file]");a.css("overflow","hidden");a.css(XF.isRtl()?"right":"left",-1E3)})},fileAdded:function(a){var b=this.applyUploadTemplate({filename:a.name,uploading:!0});this.resizeProgress(b,0);b.data("file",a);this.$filesContainer.addClass("is-active");b.appendTo(this.$filesContainer);this.fileMap[a.uniqueIdentifier]=b;this.$target.find(this.options.uploadButton).blur();if(0<XF.config.uploadMaxFilesize&&a.size>XF.config.uploadMaxFilesize)return this.uploadError(a,this.addErrorToJson({},
XF.phrase("file_too_large_to_upload"))),!1},uploadProgress:function(a){var b=this.fileMap[a.uniqueIdentifier];b&&(this.setUploading(!0),this.resizeProgress(b,a.progress()))},resizeProgress:function(a,b){b=Math.floor(100*b);a=a.find(this.options.templateProgress);var h=a.find("i");h.length||(h=c("<i />"),a.html("&nbsp;").append(h));h.text(b+"%").css("width",b+"%")},uploadSuccess:function(a,b,c){b=this.getObjectFromMessage(b);this.setUploading(!1);b.status&&"error"==b.status?this.uploadError(a,b,c):
b.attachment?this.insertUploadedRow(b.attachment,this.fileMap[a.uniqueIdentifier]):(b=this.addErrorToJson(b),this.uploadError(a,b,c))},setUploading:function(a){a=a?!0:!1;a!==this.isUploading&&((this.isUploading=a)?this.$target.trigger("attachment-manager:upload-start"):this.$target.trigger("attachment-manager:upload-end"))},getObjectFromMessage:function(a){if(a instanceof Object)return a;try{return c.parseJSON(a)}catch(b){return this.addErrorToJson({})}},addErrorToJson:function(a,b){a.status="error";
a.errors=[null===b?XF.phrase("oops_we_ran_into_some_problems"):b];return a},insertUploadedRow:function(a,b){a=this.applyUploadTemplate(a);this.editor||this.removeInsertButtons(a);b?b.replaceWith(a):(this.$filesContainer.addClass("is-active"),a.appendTo(this.$filesContainer));XF.activate(a);XF.layoutChange();b=c.Event("attachment:row-inserted");a.trigger(b,[a,this]);this.toggleInsertAllRow()},uploadError:function(a,b,c){b=this.getObjectFromMessage(b);this.setUploading(!1);var d=this.fileMap[a.uniqueIdentifier];
d&&b.errors?(d.find(this.options.templateProgress).remove(),d.find(this.options.templateError).text(b.errors[0]),d.addClass("is-uploadError"),delete this.fileMap[a.uniqueIdentifier],d.removeData("file")):(XF.defaultAjaxSuccessError(b,200,c.xhr),this.removeFileRow(d))},actionButtonClick:function(a){a.preventDefault();var b=c(a.currentTarget);a=b.attr("data-action");b=b.closest(this.options.fileRow);switch(a){case "thumbnail":case "full":this.insertAttachment(b,a);break;case "delete":this.deleteAttachment(b);
break;case "cancel":this.cancelUpload(b)}},allActionButtonClick:function(a){a.preventDefault();var b=c(a.currentTarget).attr("data-action");a=this.$filesContainer.find(this.options.fileRow+" "+this.options.actionButton);a=a.filter(function(){return c(this).attr("data-action")===b});a.click()},insertAttachment:function(a,b){var c=a.data("attachment-id");if(c&&this.editor){var d=a.find(this.options.templateThumb).attr("src");a=a.find(this.options.templateView).attr("href");var e={id:c,img:d};if("full"==
b)c="[ATTACH=full]"+c+"[/ATTACH]",b='<img src="{{img}}" data-attachment="full:{{id}}" alt="{{id}}" />',e.img=a;else{if(!d)return;c="[ATTACH]"+c+"[/ATTACH]";b='<img src="{{img}}" data-attachment="thumb:{{id}}" alt="{{id}}" />'}b=Mustache.render(b,e);XF.insertIntoEditor(this.$target,b,c,"[data-attachment-target=false]")}},deleteAttachment:function(a){var b=a.data("attachment-id");if(b){var e=this;XF.ajax("post",this.manageUrl,{delete:b},function(b){b.delete&&e.removeFileRow(a)},{skipDefaultSuccess:!0});
var d=new RegExp("^[a-z]+:"+b+"$","i"),f=new RegExp("\\[attach(=[^\\]]*)?\\]"+b+"\\[/attach\\]","gi");XF.modifyEditorContent(this.$target,function(a){var b=a.ed;b.$el.find("img[data-attachment]").filter(function(){return d.test(c(this).attr("data-attachment"))}).each(function(){b.image.remove(c(this))})},function(a){var b=a.val();b=b.replace(f,"");a.val(b)},"[data-attachment-target=false]")}},cancelUpload:function(a){var b=a.data("file");a.data("attachment-id")||b&&1==b.progress()||this.removeFileRow(a)},
uploadQueryParams:function(){return{_xfToken:XF.config.csrf,_xfResponseType:"json",_xfWithData:1}},applyUploadTemplate:function(a){a=c(c.parseHTML(Mustache.render(this.template,a)));var b=this.options.fileRow;return a.filter(function(){return c(this).is(b)})},removeFileRow:function(a){a.remove();this.toggleInsertAllRow();this.$filesContainer.find(this.options.fileRow).length||(this.$filesContainer.removeClass("is-active"),XF.layoutChange())},removeInsertButtons:function(a){a.find(this.options.insertRow+
","+this.options.insertAllRow).remove();XF.layoutChange()},toggleInsertAllRow:function(){var a=this.$filesContainer.find(this.options.actionButton).filter(":not([data-action=delete])").closest(this.options.fileRow),b=this.$filesContainer.find(this.options.insertAllRow);1<a.length?b.addClass("is-active"):b.removeClass("is-active");XF.layoutChange()}});XF.AttachmentOnInsert=XF.Element.newHandler({options:{fileRow:".js-attachmentFile",href:null,linkData:null},loading:!1,init:function(){var a=this.$target.closest(this.options.fileRow);
a.length&&this.options.href||console.error("Cannot find inserted row or action to perform.");a.on("attachment:row-inserted",XF.proxy(this,"onAttachmentInsert"))},onAttachmentInsert:function(a,b,c){if(!this.loading){var d=this;XF.ajax("post",this.options.href,this.options.linkData||{},XF.proxy(this,"onLoad")).always(function(){d.loading=!1})}},onLoad:function(a){if(a.html){var b=this;XF.setupHtmlInsert(a.html,function(a,c,e){b.$target.replaceWith(a).xfFadeDown(XF.config.speed.xfast,function(){e(!0);
XF.layoutChange()})})}}});XF.Element.register("attachment-manager","XF.AttachmentManager");XF.Element.register("attachment-on-insert","XF.AttachmentOnInsert")}(jQuery,window,document);
