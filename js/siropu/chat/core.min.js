!function(f,g,r,s){var b=navigator.userAgent;var q=/firefox/i.test(b);var m=/Edge/i.test(b);var a=!m&&/Chrome/i.test(b);var y=f("#siropuChat");var u=f("#siropuChatHeader");var A=f("#siropuChatTabs");var d=A.find('a[data-target="room-list"]');var h=A.find('a[data-target="conv-list"]');var i=A.find('a[data-target="conv-form"]');var t=f("#siropuChatContent");var B=f(".siropuChatMessages");var o=f("#siropuChatStartConversation");var p=f(".siropuChatConversation.siropuChatUsers");var j=f("#siropuChatNoConversations");var C=f("#siropuChatRooms");var z=f("#siropuChatSettings");var e=f("#siropuChatEditor");var c=e.find("form");var l=c.find("textarea");var w=f("#siropuChatBar");var v=f("#siropuChatBarMessageContainer");var n=f("#siropuChatBarUserCount span");var k=y.hasClass("siropuChatAllPages");var x=f(".siropuChatLogout");XF.SiropuChat={};XF.SiropuChat.Core=XF.Element.newHandler({options:{active:false},loggedIn:f("#XF").data("logged-in"),channel:"room",screenSize:"l",serverTime:0,pageFocus:true,pageTitle:f("title").text(),tabNotification:false,tabNotificationInterval:null,roomId:1,lastId:{},convId:0,convUnread:{},convOnly:0,convLastActive:0,noticeLastUpdate:0,messageDisplayLimit:25,notificationTimeout:5000,isVisible:true,refreshActive:5000,refreshActiveHidden:15000,refreshInactive:30000,refreshInactiveHidden:60000,refreshInterval:0,refreshSet:null,inverse:0,floadCheck:0,displayNavCount:false,forceRoom:false,inIframe:g.frameElement,dynamicTitle:true,commands:{},sounds:{},init:function(){this.getScreenSize();this.startRefreshInterval();this._initSubmitForm();this._initTabs();this._initRoomListActions();this._initRoomActions();this._initConversations();this._initAutoScrollToggle();this._initSounds();this._initOnLoad();z.on("change",f.proxy(this,"saveSettings"));w.on("click",f.proxy(this,"toggleChat"));y.on("new-message",f.proxy(this,"newMessage"));var D=this;if(k){f(".p-footer").css("padding-bottom",60)}f(g).scroll(function(){if(f(".p-navSticky").length&&f(".siropuChatAllPages.siropuChatMaximized").length){D.adjustContentHeight()}});f(g).resize(function(){D.getScreenSize()});f(g).blur(function(){D.pageFocus=false});f(g).focus(function(){D.pageFocus=true;if(D.tabNotificationInterval){clearInterval(D.tabNotificationInterval);f("title").text(D.pageTitle)}});f(r).on("click",".colorPicker-save",function(){D.saveSettings()});f(r).on("keyup",function(E){if(E.which==27&&k){D.toggleChat()}});f(r).on("click",".siropuChatMessageRow.siropuChatBot ol li b",function(){D.editorSetHtml(f(this).html())});f(r).on("siropuChat:show-load-more",".siropuChatMessages",function(){var F=f(this).data("room-id");var H=f(this).data("conv-id");if(f(this).find("> li[data-id]").length<D.messageDisplayLimit){return}var G=f('<li class="siropuChatLoadMoreMessages" style="display: none;" />');var E=f('<a class="button button--link" data-xf-click="siropu-chat-load-more-messages" />');E.html(XF.phrase("siropu_chat_load_more_messages")).appendTo(G);if(f(this).find(".siropuChatLoadMoreMessages").length){return f(this).find(".siropuChatLoadMoreMessages").fadeIn()}if(D.inverse){G.appendTo(f(this)).fadeIn();f(this).scrollTop(1000000)}else{G.prependTo(f(this)).fadeIn()}XF.activate(G)});f(r).on("click",function(E){if(k&&y.is(":visible")&&E.target.className.match("p-")){w.trigger("click")}});this.$target.on("mouseover mouseout",".siropuChatMessageRow",function(){if(f(this).find(".siropuChatMessageActions").length){f(this).find(".siropuChatDateTime, .siropuChatMessageActions").toggle()}});setTimeout(function(){D.adjustContentHeight();D.editorSetHtml("");if(y.hasClass("siropuChatPage")&&!D.inIframe&&!D.screenSizeIs("s")){D.editorFocus()}if(D.channel=="conv"&&D.getConvCount()){p.find(".siropuChatActiveConversation").trigger("click",true)}},500);if(this.isResponsive()&&this.channel=="room"){f(".siropuChatRoom.siropuChatUsers").hide()}this.noticeLastUpdate=this.serverTime;this.convLastActive=this.serverTime;this.autoScroll();this.toggleLogout()},getScreenSize:function(){if(g.matchMedia("(max-width: 768px)").matches){this.screenSize="s"}else{if(g.matchMedia("(max-width: 1024px)").matches){this.screenSize="m"}else{this.screenSize="l"}}},getRoomCount:function(){return y.find("ul[data-room-id]").length},getConvCount:function(){return y.find("li[data-conv-id]").length},screenSizeIs:function(D){return this.screenSize==D},isResponsive:function(){return(this.screenSizeIs("s")||y.hasClass("siropuChatSidebar"))},newMessage:function(E,D){if(D.action!="join"){this.playSound(D);if(!this.pageFocus){this.displayTabNotification(D);this.initDesktopNotification(D)}}},doRoomActions:function(H){var K=this;if(H.actions){for(var E in H.actions){if(this.lastId[E]===undefined){continue}var D=f('.siropuChatMessages[data-room-id="'+E+'"]');for(var I in H.actions[E]){var G=H.actions[E][I];var L=D.find('> li[data-id="'+I+'"]');for(var J in G.action){if(L.attr("data-last-change")==G.action[J]){continue}switch(J){case"edit":L.find(".siropuChatMessageText").html(G.html);break;case"delete":L.fadeOut();break;case"like":var F=L.find(".siropuChatMessageLikes");if(F.length){if(G.likes){F.replaceWith(G.likes)}else{F.remove()}}else{L.find(".siropuChatMessageText").after(G.likes)}break;case"prune":if(H.prune){D.find('> li[data-user-id="'+H.prune+'"]').remove()}else{D.find("> li").each(function(){if(f(this).data("id")<I){f(this).remove()}})}break}L.attr("data-last-change",G.action[J])}}}}},updateHeaderTitle:function(D){if(this.dynamicTitle){u.find("> span").text(D.data("title"))}},updateRooms:function(K){var N=this;var M=false;if(K.rooms===undefined){return}for(var I in K.rooms){var E=t.find('.siropuChatMessages[data-room-id="'+I+'"]');var H=t.find('.siropuChatUsers[data-room-id="'+I+'"]');var J=f(K.rooms[I]["messages"]);var F=f(K.rooms[I]["users"]);var G=K.rooms[I]["userCount"];var D=A.find('a[data-room-id="'+I+'"]');var L=H.find(".siropuChatNoRoomUsers");if(K.action!="submit"){F.each(function(){var P=f(this).data("user-id");if(P==0){O=H.find('li[data-username="'+f(this).data("username")+'"]')}else{var O=H.find('li[data-user-id="'+P+'"]')}if(O.length){O.find(".siropuChatActivityStatus").replaceWith(f(this).find(".siropuChatActivityStatus"))}else{if(f(this).hasClass("siropuChatNoRoomUsers")){H.html(f(this))}else{H.prepend(f(this));XF.activate(H);if(L.length){L.remove()}}}});D.find("span").html(G).attr("class",G?"siropuChatTabCountActive":"siropuChatTabCountInactive")}if(J.length){J=f.grep(J,function(O){return E.find('> li[data-id="'+f(O).data("id")+'"]').length?false:true});if(this.inverse){E.prepend(J)}else{E.append(J)}XF.activate(E);this.autoScroll(E);this.deleteOlderMessages(K.serverTime,E);if(!D.hasClass("siropuChatActiveTab")){D.addClass("siropuChatNewMessage")}if(f(J).length){M=true}}}this.updateLastId(K);this.updateNavUserCount(K);this.updateRoomTabs(K);this.updateBar(K);if(M){K.channel="room";y.trigger("new-message",K)}},updateConversations:function(H){var E=this;var D=false;this.convUnread={};h.find("span").html(H.convOnline).attr("class",H.convOnline?"siropuChatTabCountActive":"siropuChatTabCountInactive");if(H.convContacts){f(H.convContacts).each(function(){var K=p.find('li[data-conv-id="'+f(this).data("conv-id")+'"]');if(K.length){K.find(".siropuChatActivityStatus").replaceWith(f(this).find(".siropuChatActivityStatus"))}else{p.append(f(this));if(j.length){j.remove()}}})}if(H.convMessages){for(var J in H.convMessages){var G=f(H.convMessages[J]);var I=f('.siropuChatConversation.siropuChatMessages[data-conv-id="'+J+'"]');if(I.length){G=f.grep(G,function(K){return I.find('> li[data-id="'+f(K).data("id")+'"]').length?false:true})}else{if(!this.convId||H.convId){I=this.createConversationMessageContainer(J);I.insertBefore(o);this.convId=H.convId?H.convId:J;setTimeout(function(){p.find('li[data-conv-id="'+E.convId+'"]').click()})}}if(this.inverse){I.prepend(G)}else{I.append(G)}XF.activate(I);this.autoScroll(I);this.deleteOlderMessages(H.serverTime,I)}}if(H.convUnread){this.convUnread=H.convUnread;for(var J in H.convUnread){var F=p.find('li[data-conv-id="'+J+'"]');if(!F.hasClass("siropuChatNewMessage")){D=true}F.addClass("siropuChatNewMessage")}if(this.channel=="room"){h.addClass("siropuChatNewMessage")}}if(D){H.channel="conv";y.trigger("new-message",H)}},createRoomMessageContainer:function(D){return f('<ul class="siropuChatRoom siropuChatMessages" data-room-id="'+D+'" data-autoscroll="1" />')},createConversationMessageContainer:function(D){return f('<ul class="siropuChatConversation siropuChatMessages" data-conv-id="'+D+'" data-autoscroll="1" />')},updateNotice:function(E){var F=f("#siropuChatNotice");if(E.notice&&(E.serverTime-this.noticeLastUpdate>=60||!F.length)){var D=f(E.notice);if(F.length&&F.find("span").text()==D.find("span").text()){return}D.find("span").hide();if(F.length){F.replaceWith(D)}else{f("#siropuChatHeader").after(D)}setTimeout(function(){D.find("span").fadeIn()});this.noticeLastUpdate=E.serverTime}if(!E.notice&&F.length){F.remove()}},updateActivityStatus:function(D){if(D.action!="submit"&&(D.active&&!this.options.active||!D.active&&this.options.active)){this.options.active=D.active;y.attr("data-active",D.active);this.resetRefreshInterval()}},updateNavUserCount:function(E){if(E.action=="submit"){return}if(!this.displayNavCount){return}var D=f('a[data-nav-id="siropuChat"] span.badge');D.text(E.userCount);if(E.userCount){D.addClass("badge--active")}else{D.removeClass("badge--active")}},updateBar:function(D){if(!D.lastRow){return}v.html(D.lastRow.message);w.attr("data-room-id",D.lastRow.roomId);if(D.action!="submit"){n.html(D.userCount)}},updateRoomTabs:function(E){if(this.forceRoom==true||this.loggedIn==false||E.joinedRooms===undefined){return}if(A.length){if(this.lastId&&E.joinedRooms){for(var D in this.lastId){if(f.inArray(Number(D),E.joinedRooms)==-1){this.leaveRoomPostActions(D)}}}else{if(this.getRoomCount()){this.postLogout()}}}},updateLastId:function(D){if(D.lastId===undefined||D.lastId.length===0){return}for(var E in D.lastId){this.lastId[E]=D.lastId[E]}},getRooms:function(){XF.ajax("GET",XF.canonicalizeUrl("index.php?chat/room/list"),{},function(D){if(D.html){XF.setupHtmlInsert(D.html,function(E,F,G){C.html(E)})}})},loadRoom:function(F){var D=this;var E=f(F.roomTab);if(this.getRoomCount()==0){E.removeClass("siropuChatActiveTab")}E.insertBefore(d);var G=this.createRoomMessageContainer(F.roomId);G.prependTo(t);this._initAutoScrollToggle(G);f('<ul class="siropuChatRoom siropuChatUsers" data-room-id="'+F.roomId+'" />').prependTo(t);this.updateRooms(F);setTimeout(function(){D.doAutoScroll(G)});this.switchRoom(F.roomId);this.toggleLogout()},leaveRoom:function(E){var D=this;var E=E?E:this.roomId;XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/room/"+E+"/leave"),{},function(F){D.leaveRoomPostActions(E)},{skipDefault:true})},leaveRoomPostActions:function(E,D){y.find('[data-room-id="'+E+'"]').remove();delete this.lastId[E];XF.Cookie.remove("siropu_chat_room_id");if(D){var F=A.find("[data-room-id]:last");if(F.length){F.click()}else{d.click()}}this.toggleLogout()},leaveConversationPostActions:function(D){y.find('[data-conv-id="'+D+'"]').remove();XF.Cookie.remove("siropu_chat_conv_id");if(this.getConvCount()){p.find("li[data-conv-id]:first").click()}},autoScroll:function(D){var D=D?D:f(".siropuChatMessages");if(D.attr("data-autoscroll")==1){this.doAutoScroll(D)}},doAutoScroll:function(D){var D=D?D:f(".siropuChatMessages");if(this.inverse){D.scrollTop(0)}else{D.scrollTop(1000000)}},getSoundSetting:function(D){return z.find('input[name="sound['+D+']"]').is(":checked")},getNotificationSetting:function(D){return z.find('input[name="notification['+D+']"]').is(":checked")},getMiscSetting:function(D){return z.find('input[name="'+D+'"]').is(":checked")},getCommand:function(D){return this.commands[D]},getNotificationPhrase:function(E){var D=this.getMessageType(E);switch(D){case"mention":case"public":return XF.phrase("siropu_chat_new_public_message");break;case"private":return XF.phrase("siropu_chat_new_private_message");break;case"whisper":return XF.phrase("siropu_chat_new_whisper_message");break;default:return XF.phrase("siropu_chat_new_message");break}},getMessageType:function(D){return D.channel=="room"?D.lastRow.type:D.convLastRow.type},playSound:function(D){if(D.channel=="room"){var E=D.playSound}else{var E=D.convPlaySound}if(this.sounds[E]){this.sounds[E].play()}},initDesktopNotification:function(E){var D=this;if(!("Notification" in g)){return}if(!this.getNotificationSetting(this.getMessageType(E))){return}if(Notification.permission==="granted"){this.sendDesktopNotification(E)}else{if(Notification.permission!=="denied"){Notification.requestPermission(function(F){if(F==="granted"){D.sendDesktopNotification(E)}})}}},sendDesktopNotification:function(G){if(G.channel=="room"){var F=G.lastRow}else{var F=G.convLastRow}var D=this;var E={body:F.text,icon:F.avatar,tag:"siropuChatNotification"};var H=new Notification(this.getNotificationPhrase(G),E);setTimeout(H.close.bind(H),this.notificationTimeout);H.onclick=function(){this.close();g.focus();if(k&&y.is(":hidden")){w.click()}else{D.switchRoom()}}},displayTabNotification:function(E){var D=this;if(this.tabNotification&&!this.tabNotificationInterval){this.tabNotificationInterval=setInterval(function(){f("title").text(f("title").text()==D.pageTitle?D.getNotificationPhrase(E):D.pageTitle)},1500)}},switchRoom:function(D){A.find('a[data-room-id="'+D+'"]').click()},switchConversation:function(D){p.find('li[data-conv-id="'+D+'"]').click()},preSubmit:function(){var D=this;this.editorSetHtml("");D.editorOffPlaceholder("posting");this.responseTimeout=setTimeout(function(){D.editorSetPlaceholder("noresponse");D.editorOn();D.startRefreshInterval()},5000);this.stopRefreshInterval()},postSubmit:function(){if(this.channel=="room"&&!this.getRoomCount()||this.channel=="conv"&&!this.getConvCount()){this.editorOffPlaceholder("")}else{this.editorOn();this.editorFocus();if(this.channel=="room"){this.editorSetPlaceholder("public")}else{this.editorSetPlaceholder("private",p.find('li[data-conv-id="'+this.convId+'"]'))}}clearTimeout(this.responseTimeout);this.startRefreshInterval()},saveSettings:function(E){var D=this;if(!z.length){return}XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/save-settings"),z.serialize(),function(G){if(G.errorHtml){XF.setupHtmlInsert(G.errorHtml,function(H,I){var J=I.h1||I.title||XF.phrase("oops_we_ran_into_some_problems");XF.overlayMessage(J,H)});return true}var F="";if(E!==undefined){F=E.target.name}switch(F){case"inverse":D.inverse=D.getMiscSetting("inverse");D.autoScroll();break;case"maximized":y.toggleClass("siropuChatMaximized");D.adjustContentHeight();if(k&&!y.hasClass("siropuChatMaximized")){y.css("z-index","");t.css("height","")}break;case"display_mode":case"editor_on_top":if(F=="display_mode"&&y.hasClass("siropuChatPage")){return}XF.flashMessage(XF.phrase("siropu_chat_settings_change_reload_page"),3000);break;case"hide_bot":f(".siropuChatRoom.siropuChatMessages > li.siropuChatBot").fadeToggle();break;case"hide_chatters":y.toggleClass("siropuChatHideUserList");break;case"disable":XF.flashMessage(XF.phrase("siropu_chat_has_been_disabled"),5000);f("#siropuChat, #siropuChatBar").remove();f(r).click();break;default:if(F.match("sound")){D._initSounds()}break}},{skipDefault:true})},toggleChat:function(){y.toggle();v.toggle();this.isVisible=y.is(":visible");this.switchRoom(w.attr("data-room-id"));this.doAutoScroll();this.resetRefreshInterval();if(!this.screenSizeIs("s")){this.editorFocus()}var D=y.height()+w.height()+10;if(D>f(g).height()){this.adjustContentHeight()}},toggleAutoScroll:function(D){var F=D[0].scrollHeight-D.innerHeight();var E=parseInt(D.scrollTop());D.attr("data-autoscroll",0);if(((E==F||E+1==F||E-1==F)&&!this.inverse)||E==0&&this.inverse){D.attr("data-autoscroll",1)}if(E==0&&!this.inverse||((E==F||E+1==F||E-1==F)&&this.inverse)){D.trigger("siropuChat:show-load-more")}},toggleLogout:function(){if(this.getRoomCount()==0){x.fadeOut()}else{x.fadeIn()}},startRefreshInterval:function(){if(this.isVisible){if(this.options.active){this.refreshInterval=this.refreshActive}else{this.refreshInterval=this.refreshInactive}}else{if(this.options.active){this.refreshInterval=this.refreshActiveHidden}else{this.refreshInterval=this.refreshInactiveHidden}}this.refreshSet=setInterval(f.proxy(this,"refresh"),this.refreshInterval)},resetRefreshInterval:function(){this.stopRefreshInterval();this.startRefreshInterval()},stopRefreshInterval:function(){clearInterval(this.refreshSet)},refresh:function(){var D=this;XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/update"),{channel:D.channel,room_id:D.roomId,last_id:D.lastId,conv_id:D.convId,conv_unread:D.convUnread,conv_only:D.convOnly,conv_last_active:D.convLastActive,is_chat_page:y.hasClass("siropuChatPage")},function(E){D.updateRooms(E);D.updateConversations(E);D.updateNotice(E);D.updateActivityStatus(E);setTimeout(function(){D.doRoomActions(E)})},{skipDefault:true,global:false})},adjustContentHeight:function(){var I=f(g).height();var D=y.height();var F=t.height();var H=w.height();var E=I-D;var G=0;if(f(".p-navSticky").length&&f(".p-navSticky.is-sticky").length){G=f(".p-navSticky").height()}if(f(".siropuChatAllPages.siropuChatMaximized").length){y.css("z-index",100);t.css("height",(F+E-H-G-20)+"px")}else{if(f("#siropuChatFullPage").length){t.css("height",(F+E)+"px")}else{if(this.screenSizeIs("s")){t.css("height",(F+E-H-20)+"px")}}}},editorFocus:function(){l.froalaEditor("events.focus")},editorOn:function(){l.froalaEditor("edit.on")},editorOff:function(){l.froalaEditor("edit.off")},editorSetHtml:function(D){l.froalaEditor("html.set",D);l.froalaEditor("selection.setAfter","p");l.froalaEditor("selection.restore")},editorGetHtml:function(){return l.froalaEditor("html.get",true)},editorGetText:function(){return f.trim(l.data("froala.editor").$el.text())},editorInsertImage:function(D){l.froalaEditor("image.insert",D)},editorSetPlaceholder:function(E,D){var F=" ";switch(E){case"public":F=XF.phrase("siropu_chat_write_public_message");break;case"private":if(this.getConvCount()){F="("+D.data("username")+") "+XF.phrase("siropu_chat_write_private_message")}else{F=XF.phrase("siropu_chat_no_conversations_started")}break;case"posting":F=XF.phrase("siropu_chat_posting_message");break;case"wait":if(this.floodCheck==1000){F=XF.phrase("siropu_chat_please_wait")}else{F=XF.phrase("siropu_chat_please_wait_x_seconds")}break;case"readonly":F=XF.phrase("siropu_chat_room_is_read_only");break;case"noresponse":F=XF.phrase("siropu_chat_no_response");break}l.data("froala.editor").opts.placeholderText=F;l.froalaEditor("placeholder.refresh")},editorOffPlaceholder:function(D){this.editorOff();this.editorSetPlaceholder(D)},editorOnPlaceholder:function(D){this.editorOn();this.editorSetPlaceholder(D)},loadSound:function(D){return this.sounds[D]?this.sounds[D]:new Audio(XF.config.url.basePath+"styles/default/siropu/chat/sounds/"+D+".mp3")},postLogout:function(){for(var D in this.lastId){this.leaveRoomPostActions(D)}if(d.hasClass("siropuChatActiveTab")){this.getRooms()}else{d.click()}},setChannel:function(D){if(this.channel!=D){XF.Cookie.set("siropu_chat_channel",D)}this.channel=D},deleteOlderMessages:function(E,D){if(E-this.serverTime>=300&&D.find("> li[data-id]").length>=100&&D.data("autoscroll")==0){D.find(">li[data-id]:nth-child("+(this.inverse?"":"-")+"n+"+this.messageDisplayLimit+")").remove();this.serverTime=E}},_initRoomListActions:function(){var D=this;f(r).on("click",".siropuChatRoomInfo h3",function(){f(this).parents("li").find(".siropuChatRoomJoin").submit()});f(r).on("submit",".siropuChatRoomAction form",function(G){G.preventDefault();var F=f(this).find('button[type="submit"]');var E=f(this).find('input[name="password"]');if(E.length){E.toggle().focus();if(!E.val()){return}}F.prop("disabled",true);setTimeout(function(){F.prop("disabled",false);E.val("")},1000);XF.ajax("POST",f(this).attr("action"),f(this).serialize(),function(H){if(H.action=="join"){D.loadRoom(H)}if(H.action=="leave"){D.leaveRoomPostActions(H.roomId)}D.getRooms()})})},_initRoomActions:function(){var D=this;f(r).on("click",".siropuChatRecipients",function(){var E=f(this).data("recipients").split(", ");D.editorSetHtml("/"+D.getCommand("whisper")+" ["+E.join(", ")+"] ")});f(r).on("click",".siropuChatTag",function(){D.editorSetHtml(l.val()+" @"+f(this).next("a").text())})},_initSubmitForm:function(){var D=this;l.on("froalaEditor.initialized",function(G,E){var F=l.data("buttons-remove");if(!XF.isEditorEnabled()&&F.match(/xfBbCode/)){XF.setIsEditorEnabled(true)}E.events.on("click",function(I){if(D.channel=="conv"){var H=p.find('li[data-conv-id="'+D.convId+'"]');if(H.hasClass("siropuChatNewMessage")){H.removeClass("siropuChatNewMessage")}}});E.events.on("keyup",function(J){var I=D.getCommand("join");var L=D.editorGetText();var K=L.replace("/"+I,"").trim();if(L.match(/\/join/)&&K){var H=new XF.AutoCompleteResults({onInsert:function(M){D.editorSetHtml(L.replace(K,M));H.hideResults();c.submit()}});XF.ajax("GET",XF.canonicalizeUrl("index.php?chat/room/find"),{q:K},function(M){H.showResults(M.q,M.results,c)},{global:false,error:false})}});if(D.channel=="room"&&A.find('a[data-room-id="'+D.roomId+'"]').data("readonly")){D.editorOffPlaceholder("readonly")}if(D.channel=="room"&&!D.getRoomCount()||D.channel=="conv"&&!D.getConvCount()){D.editorOffPlaceholder("")}});c.on("submit",function(H){H.preventDefault();var E=D.editorGetHtml();var G=D.editorGetText();if(!G&&!f(E).find("img").length){return D.editorSetHtml("")}var I=f('.siropuChatMessages[data-room-id="'+D.roomId+'"]');var F=f('.siropuChatUsers[data-room-id="'+D.roomId+'"]');D.preSubmit();XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/submit"),{channel:D.channel,room_id:D.roomId,last_id:D.lastId,conv_id:D.convId,conv_unread:D.convUnread,message:E},function(J){if(J.input){D.editorSetHtml(J.input)}if(J.roomTab){D.loadRoom(J);D.postSubmit();return}if(J.find!==undefined){f(".siropuChatMessages:visible").html(f(J.messages)).attr("data-search",J.find);D.doAutoScroll();D.postSubmit();return}if(J.leaveRoom){D.leaveRoomPostActions(J.leaveRoom,true)}if(J.leaveConv){D.leaveConversationPostActions(J.leaveConv)}if(J.logout){D.postLogout()}if(J.html){XF.setupHtmlInsert(J.html,function(K,L){if(K.length){XF.overlayMessage(L.title,K)}})}if(J.prune){if(J.prune=="all"){f(".siropuChatMessages[data-room-id]").html("");D.lastId={}}else{if(J.prune=="room"){I.html("")}else{if(J.prune.user_id){I.find('> li[data-user-id="'+J.prune.user_id+'"]').html("")}}}}if(J.sanctioned){F.find('> li[data-user-id="'+J.sanctioned+'"]').remove()}D.updateRooms(J);D.updateConversations(J);D.updateNotice(J);D.updateActivityStatus(J);if(D.floodCheck){D.editorSetPlaceholder("wait")}setTimeout(function(){D.postSubmit()},D.floodCheck);if(D.channel=="conv"){D.convLastActive=J.serverTime}},{global:false})})},_initTabs:function(){var D=this;A.on("click","a",function(F){F.preventDefault();if(f(this).hasClass("siropuChatActiveTab")&&!D.isResponsive()){return}f(this).removeClass("siropuChatNewMessage");t.find("> *").hide();A.find("a.siropuChatActiveTab").removeClass("siropuChatActiveTab");f(this).addClass("siropuChatActiveTab");D.editorSetPlaceholder("public");D.updateHeaderTitle(f(this));var E=f(this).data("target");switch(E){case"room":D.roomId=f(this).data("room-id");XF.Cookie.set("siropu_chat_room_id",D.roomId);t.find('[data-room-id="'+D.roomId+'"]').show();if(f(this).data("readonly")){D.editorOffPlaceholder("readonly")}else{D.editorOnPlaceholder("public")}if(D.isResponsive()){f(".siropuChatRoom.siropuChatUsers").hide()}else{D.editorFocus()}D.autoScroll();break;case"room-list":C.toggle();D.getRooms();D.editorOffPlaceholder("");break;case"conv-list":p.show();if(D.getConvCount()){p.find('li[data-conv-id="'+D.convId+'"]').trigger("click",true)}else{D.editorOffPlaceholder("")}break;case"conv-form":o.show();if(!D.screenSizeIs("s")){o.find("input").focus()}D.editorOffPlaceholder("");break}D.setChannel(E.match(/room/)?"room":"conv")})},_initConversations:function(){var D=this;p.on("click","li[data-conv-id]",function(F,E){D.convId=f(this).data("conv-id");XF.Cookie.set("siropu_chat_conv_id",D.convId);D.updateHeaderTitle(f(this));f(this).removeClass("siropuChatNewMessage");f(".siropuChatConversation.siropuChatMessages").hide();f(this).addClass("siropuChatActiveConversation").siblings().removeClass("siropuChatActiveConversation");var H=f('.siropuChatConversation.siropuChatMessages[data-conv-id="'+D.convId+'"]');if(H.find("> li").length){H.show();D.autoScroll(H);if(D.convUnread[D.convId]){XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/conversation/"+D.convId+"/mark-as-read"),{conv_unread:D.convUnread[D.convId]},function(I){if(I.convRead){delete D.convUnread[I.convRead]}},{skipDefault:true,global:false})}}else{var G=f('<li class="siropuChatLoadingMessages" />');G.html(XF.phrase("siropu_chat_loading_conversation_messages"));H=D.createConversationMessageContainer(D.convId);H.html(G).insertBefore(o).show();D._initAutoScrollToggle(H);XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/conversation/"+D.convId+"/load-messages"),{conv_unread:D.convUnread[D.convId]},function(I){H.html(I.messages);XF.activate(H);setTimeout(function(){D.doAutoScroll(H)})})}D.editorOn();D.editorSetPlaceholder("private",f(this));if(!D.inverse&&H.find("iframe").length){setTimeout(function(){D.autoScroll(H)},1000)}if(D.isResponsive()){if(E){H.hide()}else{p.hide()}}else{D.editorFocus()}});p.on("mouseover mouseout","> li",function(){f(this).find(".siropuChatLeaveConversation").toggle()})},_initOnLoad:function(){if(this.inverse){return}var D=this;f(".siropuChatMessageText:visible img").on("load",function(){D.autoScroll()})},_initAutoScrollToggle:function(E){var D=this;var E=E?E:f(".siropuChatMessages");E.scroll(function(){D.toggleAutoScroll(f(this))})},_initSounds:function(){this.sounds.normal=this.getSoundSetting("normal")?this.loadSound("normal"):"";this.sounds.whisper=this.getSoundSetting("whisper")?this.loadSound("whisper"):"";this.sounds["private"]=this.getSoundSetting("private")?this.loadSound("private"):"";this.sounds.tag=this.getSoundSetting("tag")?this.loadSound("tag"):"";this.sounds.bot=this.getSoundSetting("bot")?this.loadSound("bot"):"";this.sounds.error=this.getSoundSetting("bot")?this.loadSound("error"):""},getChannel:function(){return this.channel},getRoomId:function(){return this.roomId},getConvId:function(){return this.convId},escapeRegExp:function(D){return isNaN(D)?D.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"):D}});XF.SiropuChat.Form=XF.Element.newHandler({options:{edit:false,multiLine:false},init:function(){var E=this;var F=this.$target;var D=F.find("textarea");D.on("froalaEditor.initialized",function(H,G){G.opts.multiLine=E.options.multiLine;G.opts.htmlAllowedTags=["img"];G.events.on("keydown",function(I){if(I.which==32&&!E.options.edit&&!XF.SiropuChat.Core.prototype.editorGetText()){I.preventDefault();return D.froalaEditor("html.set","")}if(I.which==13){if(E.options.multiLine&&I.shiftKey){return I.preventDefault()}F.submit();if(E.options.edit){F.find(".js-overlayClose").click()}}});if(E.options.edit){setTimeout(function(){D.froalaEditor("events.focus");D.froalaEditor("selection.setAfter","p");D.froalaEditor("selection.restore")},500)}else{D.froalaEditor("html.set","")}})}});XF.SiropuChat.Messages=XF.Element.newHandler({options:{},init:function(){f('a[data-xf-click="siropu-chat-quote"]').remove();this.$target.on("mouseover mouseout",".siropuChatMessageRow",function(){if(f(this).find(".siropuChatMessageActions").length){f(this).find(".siropuChatDateTime, .siropuChatMessageActions").toggle()}})}});XF.SiropuChat.FindRooms=XF.Element.newHandler({options:{},init:function(){this.$target.on("keyup",function(){var E=f(this).val().trim();var D=new RegExp(E,"gi");f("#siropuChatRooms > li[data-room-name]").hide().each(function(){if(f(this).data("room-name").match(D)){f(this).show()}})})}});XF.SiropuChat.StartConversationForm=XF.Element.newHandler({options:{},init:function(){var D=this;this.$target.on("submit",function(G){G.preventDefault();var F=f(this).find("input");var E=f(this).find("textarea");if(!F.val().trim()){return F.focus()}if(!E.val().trim()){return E.focus()}XF.ajax("POST",f(this).attr("action"),f(this).serialize(),function(H){if(j.length){j.remove()}XF.SiropuChat.Core.prototype.updateConversations(H);A.find('a[data-target="conv-list"]').click();F.val("");E.val("")})})}});XF.SiropuChat.LeaveConversation=XF.Element.newHandler({options:{},init:function(){this.$target.on("ajax-submit:response",f.proxy(this,"ajaxResponse"))},ajaxResponse:function(E,D){XF.SiropuChat.Core.prototype.updateConversations(D);XF.SiropuChat.Core.prototype.leaveConversationPostActions(D.convId)}});XF.SiropuChat.Like=XF.Click.newHandler({eventNameSpace:"SiropuChatLike",init:function(){},click:function(E){E.preventDefault();var D=this;XF.ajax("POST",this.$target.attr("href"),function(F){if(F.html){XF.setupHtmlInsert(F.html,function(G,H,I){if(G.length){D.$target.parents(".siropuChatMessageRow").replaceWith(G)}})}})}});XF.SiropuChat.Unlike=XF.Click.newHandler({eventNameSpace:"SiropuChatUnlike",init:function(){},click:function(E){E.preventDefault();var D=this;XF.ajax("POST",this.$target.attr("href"),function(F){if(F.html){XF.setupHtmlInsert(F.html,function(G,H,I){if(G.length){D.$target.parents(".siropuChatMessageRow").replaceWith(G)}})}})}});XF.SiropuChat.Quote=XF.Click.newHandler({eventNameSpace:"SiropuChatQuote",init:function(){},click:function(D){D.preventDefault();XF.ajax("POST",this.$target.attr("href"),function(E){if(E.quote){XF.SiropuChat.Core.prototype.editorSetHtml(E.quoteHtml);XF.SiropuChat.Core.prototype.editorFocus()}})}});XF.SiropuChat.LeaveRoom=XF.Click.newHandler({eventNameSpace:"SiropuChatLeaveRoom",init:function(){},click:function(E){E.preventDefault();var D=this;XF.ajax("POST",this.$target.attr("href"),function(F){XF.SiropuChat.Core.prototype.leaveRoomPostActions(F.roomId,true);D.$target.parent(".menu").toggle()})}});XF.SiropuChat.Whisper=XF.Click.newHandler({eventNameSpace:"SiropuChatWhisper",init:function(){},click:function(L){var N=this.$target.parents(".menu").attr("id");var J=f('a[aria-controls="'+N+'"').parents("li[data-user-id]").data("username");var F=XF.SiropuChat.Core.prototype.editorGetText();var G=XF.SiropuChat.Core.prototype.getCommand("whisper");var D=[];D.push(J);if(F.match(/\[(.*?)\]/)){var O=F.indexOf("[");var H=F.indexOf("]");var K=F.substring(O+1,H);if(K.length){var M=K.split(",");for(var I in M){D.push(M[I].trim())}}if(K.match(XF.SiropuChat.Core.prototype.escapeRegExp(J))){D=D.filter(function(P){return P!=J})}}var E="";if(D.length){E="/"+G+" ["+D.join(", ")+"]"}XF.SiropuChat.Core.prototype.editorSetHtml(E)}});XF.SiropuChat.Popup=XF.Click.newHandler({eventNameSpace:"SiropuChatPopup",init:function(){},click:function(D){D.preventDefault();var E;if(E===undefined||E.closed){E=g.open(D.target.href,"siropuChatWindowPopup","width=800,height=500")}else{E.focus()}}});XF.SiropuChat.LoadMoreMessages=XF.Click.newHandler({eventNameSpace:"siropuChatLoadMoreMessages",init:function(){},click:function(G){G.preventDefault();var H=this.$target;if(H.data("complete")){return}var I=H.parents("ul.siropuChatMessages");var E=I.data("room-id");var J=I.data("conv-id");var L=I.attr("data-search");var F=XF.SiropuChat.Core.prototype.getMiscSetting("inverse");if(F){var K=I.find("> li[data-id]:last")}else{var K=I.find("> li[data-id]:first")}if(E){var D="room/"+E}else{var D="conversation/"+J}XF.ajax("GET",XF.canonicalizeUrl("index.php?chat/"+D+"/load-more-messages"),{message_id:K.data("id"),find:L},function(M){if(M.messages){if(F){K.after(M.messages)}else{K.before(M.messages).get(0).scrollIntoView(false)}}if(!M.hasMore){H.attr("data-complete",true);H.html(XF.phrase("siropu_chat_all_messages_have_been_loaded"));setTimeout(function(){H.fadeOut()},5000)}})}});XF.SiropuChat.EditNotice=XF.Element.newHandler({options:{},init:function(){this.$target.on("ajax-submit:response",f.proxy(this,"ajaxResponse"))},ajaxResponse:function(E,D){if(D.message){XF.flashMessage(D.message,2000)}XF.SiropuChat.Core.prototype.updateNotice(D)}});XF.SiropuChat.ToggleUsers=XF.Click.newHandler({eventNameSpace:"siropuChatToggleUsers",init:function(){},click:function(F){var E=XF.SiropuChat.Core.prototype.getChannel();var D=XF.SiropuChat.Core.prototype.getRoomId();var G=XF.SiropuChat.Core.prototype.getConvId();if(E=="room"){f('.siropuChatUsers[data-room-id="'+D+'"]').toggle();f('.siropuChatMessages[data-room-id="'+D+'"]').toggle()}else{p.toggle();f('.siropuChatMessages[data-conv-id="'+G+'"]').toggle()}}});XF.SiropuChat.ToggleOptions=XF.Click.newHandler({eventNameSpace:"siropuChatToggleOptions",init:function(){},click:function(E){var D=this.$target.parents("fieldset").find("input");D.prop("checked",D.filter(":checked").length?false:true);z.change()}});XF.SiropuChat.ToggleConvForm=XF.Click.newHandler({eventNameSpace:"siropuChatToggleConvForm",init:function(){},click:function(E){var D=this.$target.parent(".siropuChatUserMenu").find("form");D.toggle();if(!XF.SiropuChat.Core.prototype.screenSizeIs("s")){D.find("textarea").focus()}}});XF.SiropuChat.Logout=XF.Element.newHandler({options:{},init:function(){this.$target.on("ajax-submit:response",f.proxy(this,"ajaxResponse"))},ajaxResponse:function(E,D){if(D.errors||D.exception){return}E.preventDefault();if(D.message){XF.flashMessage(D.message,3000)}XF.SiropuChat.Core.prototype.postLogout()}});XF.SiropuChat.EditorButton={init:function(){XF.SiropuChat.EditorButton.initializeDialog();XF.EditorHelpers.dialogs.chat=new XF.SiropuChat.EditorDialogGallery("chat");if(f.FE.COMMANDS.xfCustom_chat){f.FE.COMMANDS.xfCustom_chat.callback=XF.SiropuChat.EditorButton.callback}},initializeDialog:function(){XF.SiropuChat.EditorDialogGallery=XF.extend(XF.EditorDialog,{cache:false,_init:function(G){var F=this;var E=G.$container;var D=E.find(".formSubmitRow-controls");f(".siropuChatDialogInsert").click(function(I){I.preventDefault();var H="";f(".js-attachmentFileSelected").each(function(){H+=f(this).data("url")});F.ed.image.insert(H);F.overlay.hide()});f(".siropuChatDialogDelete").click(function(I){I.preventDefault();var H=[];f(".js-attachmentFileSelected").each(function(){H.push(f(this).data("attachment-id"))});if(H.length){XF.ajax("POST",XF.canonicalizeUrl("index.php?chat/delete-attachments"),{hash:E.find('input[name="hash"]').val(),remove:H,},function(J){if(J.success){f(".js-attachmentFileSelected").remove();if(!E.find(".js-attachmentFile").length){D.fadeOut()}}})}});E.on("click",".js-attachmentFile",function(){f(this).toggleClass("js-attachmentFileSelected");if(E.find(".js-attachmentFileSelected").length){D.fadeIn()}else{D.fadeOut()}})}})},callback:function(){XF.EditorHelpers.loadDialog(this,"chat")}};f(r).on("editor:first-start",XF.SiropuChat.EditorButton.init);XF.Element.register("siropu-chat","XF.SiropuChat.Core");XF.Element.register("siropu-chat-form","XF.SiropuChat.Form");XF.Element.register("siropu-chat-messages","XF.SiropuChat.Messages");XF.Element.register("siropu-chat-find-rooms","XF.SiropuChat.FindRooms");XF.Element.register("siropu-chat-start-conversation-form","XF.SiropuChat.StartConversationForm");XF.Element.register("siropu-chat-leave-conversation","XF.SiropuChat.LeaveConversation");XF.Element.register("siropu-chat-edit-notice","XF.SiropuChat.EditNotice");XF.Element.register("siropu-chat-logout","XF.SiropuChat.Logout");XF.Click.register("siropu-chat-popup","XF.SiropuChat.Popup");XF.Click.register("siropu-chat-like","XF.SiropuChat.Like");XF.Click.register("siropu-chat-unlike","XF.SiropuChat.Unlike");XF.Click.register("siropu-chat-quote","XF.SiropuChat.Quote");XF.Click.register("siropu-chat-whisper","XF.SiropuChat.Whisper");XF.Click.register("siropu-chat-leave-room","XF.SiropuChat.LeaveRoom");XF.Click.register("siropu-chat-load-more-messages","XF.SiropuChat.LoadMoreMessages");XF.Click.register("siropu-chat-toggle-users","XF.SiropuChat.ToggleUsers");XF.Click.register("siropu-chat-toggle-options","XF.SiropuChat.ToggleOptions");XF.Click.register("siropu-chat-toggle-conv-form","XF.SiropuChat.ToggleConvForm")}(jQuery,window,document);